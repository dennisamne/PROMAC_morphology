---
title: "edgeR_KO"
author: "Dennis Amnebrink"
affiliation-title: "Linnaeus University"
title-block-banner: true
date: now
editor: visual
toc: true
prefer-html: true
number-sections: true
format:
  html:
     code-fold: true
     self-contained: true
---

```{r}
SIGNIFICANCE = 0.05
MIN_COUNT = 15
MIN_SAMPLE = 2
```

```{r}
GEOM_COL_COLOURS = c(
  RColorBrewer::brewer.pal(12, name = 'Paired'))

GEOM_COL_COLOURS1 = c(GEOM_COL_COLOURS, "#D3D3D3")

TREAT_COLOURS <- c("blue","yellow4")

Order_colours <- c("Alphaproteobacteria uncl." = "#A6CEE3",
                   "B26-1" = "#1F78B4",
                   "Baldrarchaeales" = "khaki2",
                   "Burkholderiales" = "#B2DF8A",
                   "Caulobacterales" = "orchid1",
                   "CR-4" = "blue1"  ,
                   "Enterobacterales" = "#33A02C",
                   "Flavobacteriales" = "#FB9A99",
                   "Helarchaeales" = "green1"  ,
                   "Nitrososphaerales" = "black" ,
                   "Parvibaculales" = "#E31A1C",
                   "Pelagibacterales" = "deeppink1" ,
                   "Poseidoniales" = "#FDBF6F",
                   "Pseudomonadales" = "#FF7F00",
                   "Rhodobacterales" = "#CAB2D6",
                   "Syntrophorhabdales" = "#6A3D9A",
                   "Other" = "#D3D3D3"
                   )


Phylum_colours <- c(" Asgardarchaeota" = "#A6CEE3",
                    " Bacteroidota" = "#1F78B4",
                    " Campylobacterota" = "khaki2" ,
                    " Chloroflexota" = "#B2DF8A",
                    " Cyanobacteria" = "orchid1",
                    " Firmicutes" = "blue1",
                    " Patescibacteria" = "#33A02C",
                    " Proteobacteria" = "#FB9A99",
                    " Thermoproteota" = "green1",
                    "Archaea uncl." = "black",
                    " Actinobacteriota" = "#E31A1C",
                    " Desulfobacterota_G" = "deeppink1",
                    " Nanoarchaeota" = "#FDBF6F",
                    " Planctomycetota" = "#FF7F00",
                    " Thermoplasmatota" = "#CAB2D6",
                    " Verrucomicrobiota" = "#6A3D9A",
                    "Other" = "#D3D3D3"
                    
                    )
```

```{r}
#| label: libraries
#| warning: false
library(tidyverse)
library(data.table)
library(edgeR)
library(kableExtra)
library(viridis)
library(patchwork)
library(ggbreak)
library(DT)
```

```{r}
#| label: file-loading
#| warning: false
#| cache: true
#File to connect NGI ID with our own classification ID, add the Âµ-values to this file for testing later, or do that in a sep file?
sample_ID <- read_tsv("../data/J.Pinhassi_21_02_sample_info.txt") %>%
  dplyr::select(1:2) %>%
  dplyr::rename(sample = 1, sample_name = 2) %>%
  mutate(sample_name = str_replace(sample_name, "[0-9]*:","")) %>%
  separate(sample_name, c("treatment","timepoint"), sep = ",") %>%
  mutate(treatment = gsub("NT","TN", treatment)) %>%
  mutate(sample_name = paste(timepoint, treatment, sep = "_")) %>%
  separate(treatment, c("treatment","replicate"), sep = -1) %>%
  mutate(tre_rep = gsub("_","", sample_name)) %>%
  mutate(tre_rep = toupper(tre_rep)) %>%
  mutate(day = case_when( timepoint == "t3" ~ 10,
                          TRUE ~ 17
                          )
         )

target_genes <- read_tsv("../data/list_of_genes.tsv") 

#Reading in annotations
eggnogs <- read_tsv("../data2/all_samples.emapper.annotations.tsv", comment = "#")  %>%
  rename(orf = "query") 


#Count file for all orfs, tpm is calculated per sample
bbmap <- fread("../data2/counts.tsv.gz", sep = "\t") %>%
              filter(count > 0)    %>%                           # removing 0 counts to reduce size of table
              mutate(sample = str_extract(sample, "P[0-9]*_[0-9]*")) #Removing trailing sample information

rm_values <- read_tsv("../data/Rm_values.tsv")

gene_categories <- read_tsv("../data/gene_categories.tsv")

kofamscan <- fread("../data2/kofamscan2.tsv.gz", sep = "\t" ) %>%
rename(orf = "gene name",
       KEGG_ko = "KO",
       evalue = 6) %>%
  filter(evalue < 1e-5) %>%
  group_by(orf) %>%
  slice_max(order_by = score, n = 1) %>%
  ungroup() %>%
  group_by(orf) %>% #This group_by selects best hit of all KO's based on evalue (only if similar evalue)
  slice_min(order_by = evalue, n = 1) %>%
  ungroup() %>%
  group_by(orf) %>% 
  slice(1) %>% # All duplicates are now removed
  ungroup() %>%
  select(-1)

cog_legend <- read_tsv("../data2/COG_categories.tsv")

pathway_key <- read_tsv("../data/new_pathways.tsv") %>%
  rename(KEGG_Pathway = "identifier") %>%
  rbind(c(KEGG_Pathway = "-", pathway = "No entry"))

##Reading in the gtdb taxonomy

taxonomy <- read_tsv("../data2/prokka-estimated-taxonomy.out") %>%
  select(-1) %>%
  rename(orf = transcript_name) %>%
  group_by(orf) %>%
  filter(max_pid == max(max_pid)) %>%
  ungroup() %>%
  separate(
    full_classification,
    c("domain", "phylum", "class", "order", "family", "genus", "species"),
    sep = ";"
  ) %>%
  mutate(
    domain  = ifelse(is.na(domain)  | domain  == '', 'Uncl.', domain),
    phylum   = ifelse(is.na(phylum)   | phylum   == '', sprintf("%s uncl.", domain), phylum),
    class   = ifelse(is.na(class)   | class   == '', sprintf("%s uncl.", phylum), class),
    order   = ifelse(is.na(order)   | order   == '', sprintf("%s uncl.", class),  order),
    family  = ifelse(is.na(family)  | family  == '', sprintf("%s uncl.", order),  family),
    genus   = ifelse(is.na(genus)   | genus   == '', sprintf("%s uncl.", family), genus),
    species = ifelse(is.na(species) | species == '', sprintf("%s uncl.", genus),  species)
  ) %>%
  mutate(order = sub(" ", "", order))# %>%
  # mutate(phylum  = sub(" ", "", phylum))


#Loading in KO-term annotatation from kegg.jp
koUpLegend <- read_tsv("../data2/koTermsUpLegend.tsv", col_names = c("KO_term")) %>%
  separate(KO_term, c("KEGG_ko","gene"), sep = 9) %>%
  separate(gene, c("gene", "text_description"), sep = ";") %>%
  mutate(KEGG_ko = gsub("ko:","", KEGG_ko)) %>%
  mutate(gene = gsub(" ", "", gene))

koDownLegend <- read_tsv("../data2/koTermsDownLegend.tsv", col_names = c("KO_term")) %>%
  separate(KO_term, c("KEGG_ko","gene"), sep = 9) %>%
  separate(gene, c("gene", "text_description"), sep = ";") %>%
  mutate(KEGG_ko = gsub("ko:","", KEGG_ko)) %>%
  mutate(gene = gsub(" ", "", gene))

#KoNonDELegend <- read_tsv(##3) 


#Merging up and down legend for supplementary table of up/down-genes

UpDown <- rbind(koUpLegend %>% mutate(type = "Up"),
      koDownLegend %>% mutate(type = "Down")) 

nonDE_legend <- read_tsv("../data2/nonDE_legend.tsv", col_names = c("KO_term")) %>%
  separate(KO_term, c("KEGG_ko","gene"), sep = 9) %>%
  separate(gene, c("gene", "text_description"), sep = ";") %>%
  mutate(KEGG_ko = gsub("ko:","", KEGG_ko)) %>%
  mutate(gene = gsub(" ", "", gene)) %>%
  filter(!is.na(text_description))

write_tsv(nonDE_legend,"../results/non-DE_genes.tsv")
  
write_tsv(UpDown,"../results/up_down_genes.tsv")
```

```{r}
#| cache: true
#| warning: false

#Removing non-prokreads as well as recalculating tpm over prok frac.
bbmap_p <- bbmap %>% 
  semi_join(taxonomy %>% filter(domain %in% c("Bacteria", "Archaea")), 
            by = "orf") %>%
  dplyr::select(-tpm) %>%
   group_by(sample) %>%
            mutate(t = count/length) %>%
            mutate(tpm = t/sum(t)*1e6) %>%
   ungroup()
```

# EdgeR- analysis

EdgeR-analysis of the day 17 TN vs C-treatment on using the KO-system [annotation](https://www.kegg.jp/).

```{r}
#| label: edgeR-analysis
#| warning: false
#| cache: true

design <- model.matrix(~ 0 + factor(c(1,1,1,2,2,2)))
colnames(design) <- c("cold_control","warm_nutrient")

#Creating sample vector with library sizes to feed into normalization.
libSizes <- bbmap_p %>%
  semi_join(sample_ID %>% filter(day == '17'), by = 'sample') %>%
  semi_join(sample_ID %>% filter(treatment %in% c("TN","C")), by = "sample") %>%
  group_by(orf) %>%
  filter(sum(count) >= MIN_COUNT, n() >= MIN_SAMPLE) %>%
  ungroup() %>%
  select(sample, orf, count) %>%
  spread(sample, count, fill = 0) %>%
  column_to_rownames("orf") %>%
  colSums() %>%
  as.vector()
  
#Creating DGElist
dgelist <- bbmap_p %>%
  semi_join(sample_ID %>% filter(day == '17'), by = 'sample') %>%
  semi_join(sample_ID %>% filter(treatment %in% c("TN","C")), by = "sample") %>%
  group_by(orf) %>%
  filter(sum(count) >= MIN_COUNT & n() >= MIN_SAMPLE) %>%
  ungroup() %>%
  inner_join(kofamscan %>% select(orf, KEGG_ko), by = 'orf') %>%
  group_by(KEGG_ko, sample) %>%
  summarise(count = sum(count), .groups = 'drop') %>%
  ungroup() %>%
  pivot_wider(names_from = sample, values_from = count, values_fill = 0) %>%
  as.data.frame() %>%
  tibble::column_to_rownames('KEGG_ko') %>%
  DGEList(lib.size = libSizes) %>% #This is where the libSizes need to be specified. 
  calcNormFactors() %>%
  estimateDisp(design) %>%
  glmQLFit(design, robust = TRUE)

#Creating contrasts
my.contrasts <- makeContrasts(warm_nutrientvscold_control=warm_nutrient-cold_control, levels=design)

qlf.TNvsC <- glmQLFTest(dgelist, contrast=my.contrasts[,"warm_nutrientvscold_control"])
```

```{r}
#| warning: false
#| cache: true
#| label: file_writing

day17 <- topTags(qlf.TNvsC, n = Inf) %>%
  as.data.frame() %>%
  mutate(day = "17") %>%
  rownames_to_column("KEGG_ko") %>%
  select(-FDR)

edgeR_KO <- day17 %>%
  mutate(fdr = p.adjust(PValue, method = "fdr")) %>%
  mutate(type = 
           case_when(
             (fdr <= SIGNIFICANCE & logFC > 0) ~ "Up",
             (fdr <= SIGNIFICANCE & logFC < 0) ~ "Down",
             TRUE ~"non-DE"
           )) %>%
  mutate(type = forcats::as_factor(type) %>% fct_relevel("Up","non-DE","Down"))

write_tsv(edgeR_KO, "../results/edgeR_KO.tsv")
```

```{r}
edgeR_KO <- read_tsv("../results/edgeR_KO.tsv")
#Creating vectors for up and orfs part of the downregulated KO's.

upReg <- kofamscan %>%
  inner_join(edgeR_KO, by = "KEGG_ko") %>%
  filter(type == "Up") %>%
  pull(orf)

downReg <- kofamscan %>%
  inner_join(edgeR_KO, by = "KEGG_ko") %>%
  filter(type == "Down") %>%
  pull(orf)
```

## General results and the target genes

The analysis revealed 165 genes more abundant in the TN-treatment, and 178 more abundant in the C-treatment (@tbl-overview). As you soon will see, the amount of genes in the target gene list were so few, that they were included in the large scale analysis instead, but are still presented here for you to see. The section summarising the expression results is the section called "The rest of the DE-genes".

```{r}
#| label: tbl-overview
#| tbl-cap: "EdgeR summary of genefunctions"
#| warning: false
edgeR_KO <- read_tsv("../results/edgeR_KO.tsv")

kable(edgeR_KO %>%
  group_by(type) %>%
  tally() %>%
  ungroup() %>%
  rename("No. of genes" = "n")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#This is used to load into kegg webpage to get information on the terms
edgeR_KO %>% 
  filter(type == "Up") %>%
  mutate(gene = paste0("gene",row_number())) %>%
  select(gene, KEGG_ko) %>%
  write_tsv("../data2/koterms_up.tsv")

edgeR_KO %>% 
  filter(type == "Down") %>%
  mutate(gene = paste0("gene",row_number())) %>%
  select(gene, KEGG_ko) %>%
  write_tsv("../data2/koterms_down.tsv")

#Trying the mapper using all information criteria

  edgeR_KO %>%
    mutate(colour = case_when(type == "Up" ~ "red",
                              type == "Down" ~ "blue",
                              TRUE ~"grey")) %>%
    select(KEGG_ko, colour) %>%
    write_tsv("../data2/kegg_mapper.tsv")
```

```{r}
edgeR_KO %>% 
  filter(type == "non-DE") %>%
  select(KEGG_ko) %>%
  write_tsv("../data2/non_DE_KOterms.tsv")
```


#Looking at annotation coverage with COG and KEGG

```{r}
hmm <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf")


hmm %>%
  distinct(orf, KEGG_Pathway) %>%
  filter(KEGG_Pathway != "-") %>%
  nrow() #3422 annotated

hmm %>%
  distinct(orf, COG_category) %>%
  filter(COG_category != "-") %>%
  nrow() #7248 annotated
```

```{r}
#| label: fig-volcano
#| warning: false
#| eval: false
edgeR_KO %>% 
  ggplot(mapping = aes(x=logCPM, y = logFC, colour=type, size = type)) +
  geom_point()  +
  scale_size_manual(values = c("Down" = 1.5, "Up"=1.5, "non-DE" = 0.3)) +
  scale_colour_manual(values = c("Down" = "Blue","Up" = "Red", "non-DE" = "Black")) +
  theme_minimal() 
```


Among the target-gene list, only 2 genes were statistically upregulated in the TN-treatment (@tbl-Up). Thus from here we employ a different approach to identify patterns connected to morphology, summarising the overall patterns seen using the KO-terms. But first we inspect the downregulated genes below.

```{r}
#| label: tbl-Up
#| tbl-cap: "Target genes among the TN-abundant genes, and their classification."
#| warning: false

#Upload the target gene lists into kegg and get annotation that way.
#Identifying target genes in the positive DE-expressed genes
kable(edgeR_KO %>%
  filter(type == "Up") %>%
  inner_join(koUpLegend %>% separate_rows(gene, sep = ","), by = "KEGG_ko") %>% # Removing several gene-namesin one row
  inner_join(target_genes, by = "gene")
 ) %>%
   kable_styling(bootstrap_options = c("striped", "hover"))
```

The genes abundant in the C-treatment included 6 genes from the target gene list (@tbl-Down). Three of these were osmoregulatory genes involed in betaine/proline transport, and a membrane porin.

```{r}
#| label: tbl-Down
#| tbl-cap: "Target genes among the C-abundant genes, and their classification."
#| warning: false

#Identifying target genes in the negative DE-expressed genes
 kable(edgeR_KO %>%
  filter(type == "Down") %>%
  inner_join(koDownLegend %>% separate_rows(gene, sep = ","), by = "KEGG_ko") %>% # Removing several gene-namesin one row
  inner_join(target_genes, by = "gene")
 ) %>%
   kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r}
#Creating a list containing all the DE-target genes 
edgeR_KO %>%
  filter(type %in% c("Down","Up")) %>%
  inner_join(rbind(koDownLegend,koUpLegend) %>% separate_rows(gene, sep = ","), by = "KEGG_ko") %>% # Removing several gene-namesin one row
  inner_join(target_genes, by = "gene") %>%
  write_tsv("../results/DE_target_genes.tsv")
```

## The rest of the DE-genes

### Calculating tpm of DE-genes in respective treatment 

```{r}

#Calculating tpm in C treatment for C-abundant genes
bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>%
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  group_by(treatment) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup()


#Calculating tpm in TN treatment for TN-abundant genes
bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>%
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  group_by(treatment) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup()
```

### Calculating the tpm and adding taxonomy and pathway information of DE-genes in each treatment

```{r}
#| label: pathway level 2 summary vectors
#Summarising the larger KEGG categories accordign to their structure in https://www.genome.jp/kegg/pathway.html I did leave out the 1.0 category global and overview maps, as it is so wide, and obscures the rest of the patterns due to high tpm values of uninformative processes

#Global_and_overview_maps <- c("01100","01110","01120","01200","01210","01212","01230","01232","01250","01240","01220")

Carbohydrate_metabolism <- c("00010","00020","00030","00040","00051","00052","00053","00500","00520","00620","00630","00640","00650","00660","00562")

Energy_metabolism <- c("00190","00195","00196","00710","00720","00680","00910","00920")

Lipid_metabolism <- c("00061","00062","00071","00072","00073","00100","00120","00121","00140","00561","00564","00565","00600","00590","00591","00592","01040")

Nucleotide_metabolism <- c("00230", "00240") 

Amino_acid_metabolism<- c("00250","00260","00270","00280","00290","00300","00310","00220","00330","00340","00350","00360","00380","00400")

Metabolism_of_other_amino_acids<- c("00410","00430","00440","00450","00460","00471","00472","00473","00480")

Glycan_biosynthesis_and_metabolism <- c("00510","00513","00512","00515","00514","00532","00534","00533","00531","00563","00601","00603","00604","00540","00541","00550","00511","00571","00572")

Metabolism_of_cofactors_and_vitamins<- c("00730","00740","00750","00760","00770","00780","00785","00790","00670","00830","00860","00130")

Metabolism_of_terpenoids_and_polyketides<- c("00900","00902","00909","00904","00906","00905","00981","00908","00903","00281","01052","00522","01051","01059","01056","01057","00253","00523","01054","01053","01055")

Biosynthesis_of_other_secondary_metabolites <- c("00940","00945","00941","00944","00942","00943","00901","00403","00950","00960","01058","00232","00965","00966","00402","00311","00332","00261","00331","00521","00524","00525","00401","00404","00405","00333","00254","00999","00998","00997")

Xenobiotics_biodegradation_and_metabolism <- c("00362","00627","00364","00625","00361","00623","00622","00633","00642","00643","00791","00930","00363","00621","00626","00624","00365","00984","00980","00982","00983")

Chemical_structure_transformation_maps <- c("01010","01060","01061","01062","01063","01064","01065","01066","01070")

Transcription <- 
  c("03020","03022", "03040")

Translation <-
  c("03010","00970","03013","03015","03008")
 
Folding_sorting_and_degradation <-
  c("03060","04141","04130","04120","04122","03050","03018")

Replication_and_repair <- 
  c("03030","03410","03420","03430","03440","03450","03460")

 #This category is removed from the category-vector due to no hits at all among the DE-genes
Information_processing_in_viruses <-
   c("03230","03240","03250","03260","03262","03261","03263","03264","03265","03266","03268","03267")
 
 Membrane_transport <-
   c("02010","02060","03070")
 
 Signal_transduction <- 
   c("02020","04010","04013","04016","04011","04012","04014","04015","04310","04330","04340","04341","04350", "04390","04391","04392","04370","04371","04630","04064","04668","04066","04068","04020","04070","04072","04071","04024","04022","04151","04152","04150","04075")
 
 Cellular_community_prokaryotes <-
   c("02024","05111","02025","02026")
 
 Cell_motility <-
   c("02030","02040","04814","04810")
 
 

categories <- c( "Carbohydrate_metabolism", "Energy_metabolism", "Lipid_metabolism", "Nucleotide_metabolism", "Amino_acid_metabolism", "Metabolism_of_other_amino_acids", "Glycan_biosynthesis_and_metabolism", "Metabolism_of_cofactors_and_vitamins", "Metabolism_of_terpenoids_and_polyketides", "Biosynthesis_of_other_secondary_metabolites", "Xenobiotics_biodegradation_and_metabolism", "Chemical_structure_transformation_maps", "Transcription","Translation","Folding_sorting_and_degradation","Replication_and_repair", "Membrane_transport","Signal_transduction","Cellular_community_prokaryotes","Cell_motility")
```

```{r}
#Adding the larger level information
orf_KEGG2_key <- eggnogs %>%
  separate_rows(KEGG_Pathway, sep = ",") %>%
  mutate(KEGG_Pathway = gsub("^[a-z]*", "", KEGG_Pathway)) %>%
  distinct(orf, KEGG_Pathway) %>%
  mutate(KEGG_level_2 = case_when(
    #KEGG_Pathway %in% Global_and_overview_maps ~ "Global_and_overview_maps",
    KEGG_Pathway %in% Carbohydrate_metabolism ~ "Carbohydrate metabolism",
    KEGG_Pathway %in% Energy_metabolism ~ "Energy metabolism",
    KEGG_Pathway %in% Lipid_metabolism ~ "Lipid metabolism",
    KEGG_Pathway %in% Nucleotide_metabolism ~ "Nucleotide metabolism",
    KEGG_Pathway %in% Amino_acid_metabolism ~ "Amino acid metabolism",
    KEGG_Pathway %in% Metabolism_of_other_amino_acids ~ "Metabolism of other amino acids",
    KEGG_Pathway %in% Glycan_biosynthesis_and_metabolism ~ "Glycan biosynthesis and metabolism",
    KEGG_Pathway %in% Metabolism_of_cofactors_and_vitamins ~ "Metabolism of cofactors and vitamins",
    KEGG_Pathway %in% Metabolism_of_terpenoids_and_polyketides ~ "Metabolism of terpenoids and polyketides",
    KEGG_Pathway %in% Biosynthesis_of_other_secondary_metabolites ~ "Biosynthesis of other secondary metabolites",
    KEGG_Pathway %in% Xenobiotics_biodegradation_and_metabolism ~ "Xenobiotics biodegradation and metabolism",
    KEGG_Pathway %in% Chemical_structure_transformation_maps ~ "Chemical structure transformation maps",
    KEGG_Pathway %in% Transcription ~ "Transcription",
    KEGG_Pathway %in% Translation ~ "Translation",
    KEGG_Pathway %in% Folding_sorting_and_degradation ~ "Folding sorting and degradation",
    KEGG_Pathway %in% Replication_and_repair ~ "Replication and repair",
    KEGG_Pathway %in% Information_processing_in_viruses ~ "Information processing in viruses",
    KEGG_Pathway %in% Membrane_transport ~ "Membrane transport",
    KEGG_Pathway %in% Signal_transduction ~ "Signal transduction", #Not adding a last line here gives all PW's not present NA's.
    KEGG_Pathway %in% Cellular_community_prokaryotes ~ "Cellular community prokaryotes",
    KEGG_Pathway %in% Cell_motility ~ "Cell motility"
  ))
```

```{r}

#Calculating most abundant orders in among the genes more abundant in the C-treatment
top10_order <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>%
  group_by(order) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(order)

#Calculating most abundant KEGG2-pathways
top10_paths2 <-  bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in pathway
  inner_join(orf_KEGG2_key, by = "orf") %>%
  group_by(KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 != "NA") %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(KEGG_level_2)
  

#C-fraction
p1 <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>% #Join in larger pathway information
  mutate(order = ifelse(order %in% top10_order, paste0(order), paste0("Other"))) %>%
  inner_join(orf_KEGG2_key, by = "orf") %>%
  group_by(treatment, order, KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 %in% top10_paths2) %>%
  mutate(KEGG_level_2 = factor(KEGG_level_2, levels = rev(top10_paths2))) %>%
  ggplot(mapping = aes(x = KEGG_level_2, y = tpm/10000, fill = order)) +
  geom_col() +
  scale_fill_manual('Order', values =  GEOM_COL_COLOURS1) +
  theme_minimal() +
  xlab("KEGG category") +
  ylab(bquote('tpm x '(10^4))) +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold"),
        legend.key.size = unit(0.2, "cm")) +
  coord_flip() +
 guides(fill=guide_legend(nrow = 6, title.position = "top")) +
 scale_fill_manual('Order', values = Order_colours) +
  labs(tag = "a") 

p1
```

```{r}
#Calculating most abundant orders in among the genes more abundant in the C-treatment
top10_order <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>%
  group_by(order) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(order)

#Calculating most abundant KEGG2-pathways
top10_paths2 <-  bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in pathway
  inner_join(orf_KEGG2_key, by = "orf") %>%
  filter(KEGG_level_2 != "NA") %>%
  group_by(KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(KEGG_level_2)
  

#TN-fraction
p2 <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>% #Join in larger pathway information
  mutate(order = ifelse(order %in% top10_order, paste0(order), paste0("Other"))) %>%
  inner_join(orf_KEGG2_key, by = "orf") %>%
  group_by(treatment, order, KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 %in% top10_paths2) %>%
  mutate(KEGG_level_2 = factor(KEGG_level_2, levels = rev(top10_paths2))) %>%
  ggplot(mapping = aes(x = KEGG_level_2, y = tpm/10000, fill = order)) +
  geom_col() +
  scale_fill_manual('Order', values = Order_colours) +
  theme_minimal() +
  xlab("") +
  ylab(bquote('tpm x '(10^4))) +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold"),
        legend.key.size = unit(0.2, "cm")) +
  coord_flip() +
  guides(fill=guide_legend(nrow = 6, title.position = "top")) +
  labs(tag = "b")

p2
```

```{r}
## PLot combinatorics

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.justification = "left")

ggsave("../results/KEGG_DE_paths.tiff",  bg = "white", width = 18, height = 12, units = "cm", dpi = 330)
```

### Doing the phylum level version as requested
```{r}
#Calculating most abundant orders in among the genes more abundant in the C-treatment
top10_phylum <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>%
  group_by(phylum) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(phylum)

#Calculating most abundant KEGG2-pathways
top10_paths2 <-  bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in pathway
  inner_join(orf_KEGG2_key, by = "orf") %>%
  group_by(KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 != "NA") %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(KEGG_level_2)
  

#C-fraction
p1 <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% downReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>% #Join in larger pathway information
  mutate(phylum = ifelse(phylum %in% top10_phylum, paste0(phylum), paste0("Other"))) %>%
  inner_join(orf_KEGG2_key, by = "orf") %>%
  group_by(treatment, phylum, KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 %in% top10_paths2) %>%
  mutate(KEGG_level_2 = factor(KEGG_level_2, levels = rev(top10_paths2))) %>%
  ggplot(mapping = aes(x = KEGG_level_2, y = tpm/10000, fill = phylum)) +
  geom_col() +
  scale_fill_manual('Phylum', values =  GEOM_COL_COLOURS1) +
  theme_minimal() +
  xlab("KEGG category") +
  ylab(bquote('tpm x '(10^4))) +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold"),
        legend.key.size = unit(0.2, "cm")) +
  coord_flip() +
 guides(fill=guide_legend(nrow = 6, title.position = "top")) +
 scale_fill_manual('Phylum', values = Phylum_colours) +
  labs(tag = "a") 

p1
```

```{r}
#Calculating most abundant orders in among the genes more abundant in the TN-treatment
top10_phylum <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>%
  group_by(phylum) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(phylum)

#Calculating most abundant KEGG2-pathways
top10_paths2 <-  bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in pathway
  inner_join(orf_KEGG2_key, by = "orf") %>%
  filter(KEGG_level_2 != "NA") %>%
  group_by(KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(KEGG_level_2)
  

#TN-fraction
p2 <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(orf %in% upReg) %>% #Filtering out the genes statistically more abundant in the C-treatment
  filter(treatment %in% c("TN")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>% #Join in taxonomy
  inner_join(taxonomy, by = "orf") %>% #Join in larger pathway information
  mutate(phylum = ifelse(phylum %in% top10_phylum, paste0(phylum), paste0("Other"))) %>%
  inner_join(orf_KEGG2_key, by = "orf") %>%
  group_by(treatment, phylum, KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 %in% top10_paths2) %>%
  mutate(KEGG_level_2 = factor(KEGG_level_2, levels = rev(top10_paths2))) %>%
  ggplot(mapping = aes(x = KEGG_level_2, y = tpm/10000, fill = phylum)) +
  geom_col() +
 scale_fill_manual('Phylum', values = Phylum_colours) +
  theme_minimal() +
  xlab("") +
  ylab(bquote('tpm x '(10^4))) +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold"),
        legend.key.size = unit(0.2, "cm")) +
  coord_flip() +
  guides(fill=guide_legend(nrow = 6, title.position = "top")) +
  labs(tag = "b")

p2

phyla_colours <- c(unique(p1$data$phylum),unique(p2$data$phylum))

phyla_int <- unique(phyla_colours)
```

```{r}
p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.justification = "left")


```
```{r}
ggsave("../results/KEGG_DE_paths_phylum.tiff",  bg = "white", width = 18, height = 12, units = "cm", dpi = 330)
```


### The differentially abundant genes

Here I employ a legend to relate the genes to the morphological charateristics

ð¢ - Gene is related to cell-cell connections and aggregation (higher in TN-treatment)

ð  - Gene is related to OMV's (Higher in TN-treatment)

#### electron-transport chain:

*ccmF*\
*ccmG*\
*coxA*\

#### Morphology genes:

[*csgB*](https://www.kegg.jp/entry/K04335) a minor curlin subunit\
**Flagellar and flagellin related genes**\
[*flaG*](https://www.kegg.jp/entry/K06603)\
[*flgB*](https://www.kegg.jp/entry/K02387)\
[flgO](https://www.kegg.jp/entry/K24344)\
[*fliC*](https://www.kegg.jp/entry/K02406)\
[*fliD*](https://www.kegg.jp/entry/K02407)\
[*pilU*](https://www.kegg.jp/entry/K02670) a twitching motility protein\
Adherence proteins in [T2SS](https://en.wikipedia.org/wiki/Type_II_secretion_system), which is coupled with quorom sensing, and not pathogenic popped up:\
[*tadB*](https://www.kegg.jp/entry/K12510) ð¢\
[*tadC*](https://www.kegg.jp/entry/K12511) ð¢\
[*tadE*](https://www.kegg.jp/entry/K12513) ð¢\
[*rpoS*](https://www.kegg.jp/entry/K03087) sigma factor involved in biofilm formation. ð¢\
[*glgA*](https://www.kegg.jp/entry/K00703) a starch synthase involved in biofilm formation. ð¢\
[*csrA*](https://www.kegg.jp/entry/K03563) a carbon storage regulator involved in biofilm formation. ð¢\
[*bifA*](https://www.kegg.jp/entry/K21024) - a phosphodiesterase involved in biofilm formation. ð¢\

#### Chemotaxis and quorom sensing:

[*mcp*](https://www.kegg.jp/entry/K03406), involved in bacterial chemotaxis ð¢\
[*ABC.SP.A*](https://www.kegg.jp/entry/K02052) - putrescine/spermedine related invoved in quorom sensing among others ð¢\

#### Multidrug resistance:

[*mexT*](https://www.kegg.jp/entry/K18297).\

#### Viral and defense genes:

[*hsdR*](https://www.kegg.jp/entry/K01153) - type1-restriction enzyme\
[*K07317*](https://www.kegg.jp/entry/K07317) - a type2 R-M system\
[*uvsW*](https://www.kegg.jp/entry/K18959) - a viral protein encoding gene\
[*gp23*](https://www.kegg.jp/entry/K21079) - phage major capsid protein\
[*gp46*](https://www.kegg.jp/entry/K26043) - phage exonuclease subunit (by virus, not defense)\
[*gp47*](https://www.kegg.jp/entry/K26048) - phage exonuclease subunit (by virus, not defense)\
[*gp55*](https://www.kegg.jp/entry/K22007) - phage poymerase sigma factor\

#### LPS and OMV's:

[*waaJ*](https://www.kegg.jp/entry/K03279) - LPS biosynthesis ð \
[*wbyK*](https://www.kegg.jp/entry/K13001) - LPS biosynthesis ð \
[*SEPT4*](https://www.kegg.jp/entry/K16943) - involved in membrane trafficking exocytosis, as well as apoptosis (but eukaryotic, homolog?) ð \

What matches our data? Well the adherence proteins I think reflects a bit what we see. **Especially the adherence proteins together with the biofilm-formation genes may explain the aggregation patterns observed in the microscopy.** An interesting note is the occurence of 5 phage genes in conjunction with two defense genes, suggesting that phage infection and defense is on-going in the TN-treatment as opposed to the C-treatment.\
\
The appearance of the flaggellin and curli-genes are in opposition to what we see in the microscopy, there are more structures of filaments in the C-treatment, however these genes appear upregulated in the TN-treatment, it might be that these genes are used in the cell-cell connections in some way, rather than moving around, but it needs confirmation that pili-genes can be involved in this rather than mobility alone.

### The C-abundant genes

Legend for maintenance associated activities

ð£ - osmoregulation

ðµ - ribosomal proteins and translation related genes

This is still a work in progress...

Here subunits of the F-type ATPase was more abundant:\
[*ATPeF0A*](https://www.kegg.jp/entry/K02126), subunit a [*ATPF0A*](https://www.kegg.jp/entry/K02108), subunit a [*ATPF0B*](https://www.kegg.jp/entry/K02109), subunit b [*ATPeF0C*](https://www.kegg.jp/entry/K02128), subunit c

one morphology gene upregulated in the C-treatment [*flgE*](https://www.kegg.jp/entry/K02390)

Genes related to proline-metabolism, known to be important for osmoregulation were upregulated in the C-treatment

[*proX*](https://www.kegg.jp/entry/K02002)ð£*\
[proW](https://www.kegg.jp/entry/K02001)* ð£\
[*ompF*](https://www.kegg.jp/entry/K09476) an outer membrane protein defined as osmoregulatory ð£

Ribosome and translation processes:

[*rplJ*](https://www.kegg.jp/entry/K02864) ðµ\

[*RPL14*](https://www.kegg.jp/entry/K02875) ðµ\

[*RPL15*](https://www.kegg.jp/entry/K02877) ðµ\

[*rplX*](https://www.kegg.jp/entry/K02895) ðµ\

[*rplC*](https://www.kegg.jp/entry/K02906) ðµ\

[*rplE*](https://www.kegg.jp/entry/K02931) ðµ\

[*rplL*](https://www.kegg.jp/entry/K02935) ðµ\

[*rpsJ*](https://www.kegg.jp/entry/K02946) ðµ\

[*rpsL*](https://www.kegg.jp/entry/K02950) ðµ\

[*rpsO*](https://www.kegg.jp/entry/K02956) ðµ\

[*rpsB*](https://www.kegg.jp/entry/K02967) ðµ\

[*rpsG*](https://www.kegg.jp/entry/K02992) ðµ\

[*EIF1A*](https://www.kegg.jp/entry/K03236) ðµ\

[*EIF4A*](https://www.kegg.jp/entry/K03257) ðµ\

[*EIF4E*](https://www.kegg.jp/entry/K03259) ðµ\

[*EIF5*](https://www.kegg.jp/entry/K03262) ðµ\

Thus we see several ribosome and translation genes statistically more abundant in the C-treatment. The pro-genes and porin are worth mentioning, but do not deserve more than a sentence as there are not so many genes involved in this pathway, perhaps if they have a large transcription in the C-treatment this will give validity.

## Summary

To recapitulate, morphological charateristics that were over-represented in the TN-treatment included Outer membrane blebbing and release of outer membrane vesicles, this was also true for the combination of connections between cells and blebbing (@fig-morphologies). The genes supporting what we see then includes the biofilm and adhesion genes that might help explain the bactteriall aggregation seen, there are allso three genes involved in LPS biosynthesis and exocytosis, which might explain the outer membrane vesicles seen in the TN-treatment. A sidenote is the presence of phage-genes being expressed, suggesting a top-down pressure by phages in the TN-treatment, and bacterial defense systems responding to this.\

Genes and systems supporting the occurrence of OMV's in the TN-treatment include :

The LPS and OMV's categories

Quorom-sensing and chemotaxis

The maintenance related activties in the C-treatment does not really get a large support, but three genes related to osmoregulation show up, and several ribosomal proteins pop-up, potentially reflecting cold adaptation.

::: {#fig-morphologies layout="[[1], [1,1]]"}
![morphSummary](../data2/morphology_summary.jpg){#fig-summary}

![morphSlides1](../data2/Microscopy_slide1.jpg){#fig-morphslide1}

![morphSlides2](../data2/morphology_slide2.jpg){#fig-morphslide2}

Morphological traits
:::

# Figures based on above genelist

```{r}
#| label: fig-DETPM
#| fig-cap: "the most abundant weighted genes in each treatment."
#| warning: false
#| eval: false
bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  inner_join(kofamscan, by = "orf") %>% #Adding the kO-terms and summarising tpm per treatment and KO-term
  group_by(treatment, KEGG_ko) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  inner_join(rbind(koDownLegend, koUpLegend), by = "KEGG_ko") %>%
  mutate(gene = forcats::as_factor(gene) %>% fct_reorder(tpm, .desc = TRUE)) %>%
  group_by(treatment) %>% #Selecting top50 KO's per treatment
  arrange(desc(tpm)) %>%
  slice_head(n = 50) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = gene, y = tpm)) +
  geom_col() +
  facet_wrap(~treatment, scales = "free") +
  theme(axis.text.x = element_text(hjust = 1, angle = 90)) 
```

Plotting the most relevant genes based on change\*abundance, very few are involved in any of the interesting processes (@fig-weighted).

```{r}
#| label: fig-weighted
#| fig-cap: "the most abundant weighted genes in each treatment."
#| warning: false

#Plotting the logCPM*logFC ordering version, as presented before, and adding annotation based on what activities the bugs are involved in
#Adding annotation of known processes among the known genes


edgeR_KO %>%
  mutate(weighted = logFC*logCPM) %>%
  inner_join(rbind(koDownLegend, koUpLegend), by = "KEGG_ko") %>% #Adding known annotations
  arrange(desc(weighted)) %>%
  slice(1:50, (nrow(.)-49):nrow(.)) %>% #selecting largest and lowest weighted values respectively
  ungroup() %>% view()
  
```

On the other hand we can see the distribution of the specified processes by plotting only the genes in processes of interest (@fig-process_weighted).

```{r}
#| label: fig-process_weighted
#| fig-cap: "The abundance and change of the genes involved in relevant processes"
#| warning: false

aggregationGenes <- c("tadB","tadC","tadE","rpoS","glgA","csrA","bifA","mcp","ABC.SP.A") #Green colour

LPSOMV <- c("waaJ, rfaJ","wbyK","SEPT4") #Orange colour

osmoReg <- c("proX","proW","ompF") #Purple colour

riboAndTransl <- c("RP-L10, MRPL10, rplJ","RP-L14e, RPL14","RP-L15e, RPL15","RP-L24, MRPL24, rplX","RP-L3, MRPL3, rplC","RP-L5, MRPL5, rplE","RP-L7, MRPL12, rplL","RP-S10, MRPS10, rpsJ","RP-S12, MRPS12, rpsL","RP-S15, MRPS15, rpsO","RP-S2, MRPS2, rpsB","RP-S7, MRPS7, rpsG","EIF1A","EIF4A","EIF4E","EIF5") # Blue colour

ViralDef <- c("hsdR")

ATPSynthase <- c("ATPeF0C, ATP5G, ATP9","ATPeF0A, MTATP6, ATP6","ATPF0A, atpB","ATPF0B, atpF")

Motility <- c("fliD","fliC, hag")

MacroMoc <- c("phaC, phbC")


Oxido <- c("katG","fpr","qor, CRYZ")

shapeVec <- c(0, 1, 2, 4, 5, 6, 15, 16, 17, 18)

edgeR_KO %>%
  mutate(weighted = logFC*logCPM) %>%
  inner_join(rbind(koDownLegend, koUpLegend), by = "KEGG_ko") %>% #Adding known annotations
  arrange(desc(weighted)) %>%
  #slice(1:50, (nrow(.)-49):nrow(.)) %>% #selecting largest and lowest weighted values respectively
  ungroup() %>%
  mutate(gene = forcats::as_factor(gene) %>% fct_reorder(logFC, .desc = TRUE)) %>%
  mutate(process = case_when(
    gene %in% aggregationGenes ~ "Aggregation & cell-cell connections",
    gene %in% LPSOMV ~ "Membrane vesicles",
    gene %in% osmoReg ~ "Osmoregulation",
    gene %in% riboAndTransl ~ "Ribosome and translation",
    gene %in% ViralDef ~ "Viral defense",
    gene %in% ATPSynthase ~ "ATP synthase",
    gene %in% Motility ~ "Motility",
    gene %in% MacroMoc ~ "Macromolecular turnover",
    gene %in% Oxido ~ "Oxidoreductase",
    TRUE ~ "None"
  )) %>% 
  filter(process != "None") %>%
  filter(type != "non-DE") %>%
  ggplot(mapping = aes(y = gene, x= logFC, shape = process)) +
  geom_point(aes(size = logCPM, colour = fdr)) +
  scale_colour_viridis(discrete = FALSE) +
  theme_minimal()  +
  scale_shape_manual('Process', values = shapeVec)

ggsave("../results/manualCats.pdf", bg = "white")

ggsave("../results/manualCats.tiff",dpi = 330, bg = "white")
```
## GoI Plot
```{r}
#Doing a new logFC pllot of genes of interest based on the new set of genes

GoI <- read_tsv("../data2/GeneList_updated.tsv") %>%
  mutate(Process = ifelse(Process == "signal transduction", paste0("Signal transduction"), paste0(Process)))

scale25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

edgeR_KO %>%
  mutate(weighted = logFC*logCPM) %>%
  arrange(desc(weighted)) %>%
  #slice(1:50, (nrow(.)-49):nrow(.)) %>% #selecting largest and lowest weighted values respectively
  ungroup() %>%
  inner_join(GoI %>% select(-type), by = "KEGG_ko") %>%
  mutate(KO_gene = paste(KEGG_ko, gene_name, sep = "; ")) %>%
  mutate(KO_gene = forcats::as_factor(KO_gene) %>% fct_reorder(logFC, .desc = TRUE)) %>%
  rename(LogCPM = "logCPM") %>%
  ggplot(mapping = aes(y = KO_gene, x= logFC,  colour = Process)) +
  geom_point(aes(size = LogCPM)) +
  #scale_colour_viridis(discrete = FALSE) +
  theme_minimal()  +
  scale_colour_manual('Process', values = scale25) +
  ylab("Gene name") +
  xlab(expression(Log["2"]~fold~change)) +
  theme(legend.text = element_text(size = 9),
        axis.text.x = element_text(size = 9))

ggsave("../results/GoI.tiff", bg = "white", width = 18, height = 18, units = "cm", 
       dpi = 330)
```

```{r}
#enumerating the rest of the fli-genes
edgeR_KO %>%
  mutate(weighted = logFC*logCPM) %>%
  inner_join(KoNonDELegend, by = "KEGG_ko") %>%
  filter(str_detect(gene, "fli")) %>%
  distinct(gene)
```

## Fig. COG-categories

To see large-scale patterns, the [COG-categories](https://www.ncbi.nlm.nih.gov/research/cog#) were plotted to understand responses better (@fig-cogCats), the B-panel shoes the taxonomic contribution of all the statistically differentially abundant genes. The tpm values were average across samples and fraction to identify taxonomic fidelity of the functional categories. The taxonomic contribution overall showed a lot of taxa annotated only as bacteria, and a stronger presence of Archaea in the C-Treatment-enriched genes. The categories which show responses in the C-treatment are:\
Translation, ribosomal structure and biogenesis\
Energy production and conversion\
RNA processing and modification\

```{r}
#| label: fig-cogCats
#| fig-cap: "The abundance and change of the genes involved in relevant processes.Dowen denotes genes significantly abundant in the C-treatment, uo denotes genes significanly more abundant in the TN-treatment."
#| fig-subcap: 
#|   - "tpm contribution of the DE-genes in each treatment and statistical group, per COG-category"
#|   - "Taxonomic contribution to each category"
#| warning: false
#| layout-ncol: 1


#Create ordering of tpm based on abundance

SelCats <- c(cog_legend$full_name[1], cog_legend$full_name[17], cog_legend$full_name[2], cog_legend$full_name[9], cog_legend$full_name[10], cog_legend$full_name[14], cog_legend$full_name[18], cog_legend$full_name[19])

#Start with large scale categories
bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  separate_rows(COG_category, sep = '(?<=.)(?=.)') %>% #Dealing with multiple category assignments
  group_by(treatment, type, COG_category) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(COG_category != "-") %>%
  #mutate(COG_category = forcats::as_factor(COG_category) %>% fct_reorder(tpm, .desc = FALSE)) %>%
  inner_join(cog_legend, by = "COG_category") %>%
 #mutate(full_name = forcats::as_factor(full_name) %>% fct_reorder(tpm, .desc = FALSE)) %>%
  filter(full_name %in% SelCats) %>%
  ggplot(mapping = aes(x = fct_relevel(full_name, rev(SelCats)), y = tpm, fill = type)) +
  geom_col() +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  ylab("Transcripts per million") +
  theme(legend.title = element_text(face = "bold")) +
  scale_fill_manual('Type', values = c("C-DE" = TREAT_COLOURS[1],"TN-DE" = TREAT_COLOURS[2], "non-DE" = "grey68")) +
  xlab("COG category") +
  coord_flip() +
  facet_wrap(~ treatment)

ggsave("../results/COG_cats.pdf", bg = "white", width = 18, height = 12, unit = "cm")
ggsave("../results/COG_cats.tiff", bg = "white", width = 18, height = 12, units = "cm", 
       dpi = 330)
  

  #Taxonomic contribution of COG-categories
    #Deciding the top 10 taxonomies

top10 <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  separate_rows(COG_category, sep = '(?<=.)(?=.)') %>%
  filter(COG_category != "-") %>%
  inner_join(cog_legend, by = "COG_category") %>%
  filter(full_name %in% SelCats) %>%
  inner_join(bbmap_p %>% distinct(orf, chr), by = "orf") %>% #Getting contig for taxonomy annotation
  inner_join(taxonomy %>% filter(superkingdom %in% c("Bacteria", "Archaea")), by = "chr") %>%
  mutate(class = na_if(class, "no support"),
         phylum = na_if(phylum, "no support")) %>%
  mutate(taxa_group = coalesce(class, phylum, superkingdom))  %>%
  group_by(taxa_group) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(taxa_group)

#Fix the order of categories to match the above plot 

levelVec <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  separate_rows(COG_category, sep = '(?<=.)(?=.)') %>%
  group_by(treatment, type, COG_category) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(COG_category != "-") %>%
  mutate(COG_category = forcats::as_factor(COG_category) %>% fct_reorder(tpm, .desc = FALSE)) %>%
  pull(COG_category) %>%
  levels()

# Adding taxonomy to plot in each category and DE-fraction #mutate in the prefix for each taxonomic level.
bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf) %>% #mean tpm regardless of treatment
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  separate_rows(COG_category, sep = '(?<=.)(?=.)') %>%
  inner_join(bbmap_p %>% distinct(orf, chr), by = "orf") %>% #Getting contig for taxonomy annotation
  inner_join(taxonomy %>% filter(superkingdom %in% c("Bacteria", "Archaea")), by = "chr") %>%
  mutate(class = na_if(class, "no support"),
         phylum = na_if(phylum, "no support")) %>% #Replacing the no support wth NA
  mutate(taxa_group = coalesce(class, phylum, superkingdom))  %>%
  mutate(taxa_group = ifelse(taxa_group %in% top10, paste0(taxa_group), paste0("Other"))) %>%
  mutate(taxa_group = case_when(taxa_group == superkingdom ~ paste0("d_",taxa_group),
                                 taxa_group == phylum ~ paste0("p_",taxa_group),
                                 taxa_group == class ~ paste0("c_", taxa_group),
                                 TRUE ~ paste0(taxa_group))) %>% 
  group_by(type, COG_category, taxa_group) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(COG_category != "-") %>%
  mutate(COG_category = factor(COG_category, levels = levelVec)) %>%
  group_by(type, COG_category) %>%
  mutate(relab = tpm/sum(tpm)) %>%
  ungroup() %>%
  inner_join(cog_legend, by = "COG_category") %>%
  filter(full_name %in% SelCats) %>%
  ggplot(mapping = aes(x = fct_relevel(full_name, rev(SelCats)), y = relab, fill = fct_relevel(taxa_group, "Other", after = Inf))) +
  geom_col() +
  theme_minimal() +
  xlab("COG category") +
  ylab("Relative abundance") +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold")) +
  coord_flip() +
  facet_grid(~ type) +
  guides(fill=guide_legend(ncol=2, title.position = "top")) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS) +
  scale_y_continuous(labels=c(0,0.25,0.50,0.75,1))

ggsave("../results/COG_cats_taxonomy.tiff", bg = "white", width = 18, height = 12, units = "cm", dpi = 330)
```

## Fig KEGG-categories

```{r}
#Getting the most abundant annotated pathways 

 #Taxonomic contribution of KEGG-categories
    #Deciding the top 10 taxonomies

topPathlevels <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
   filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_Pathway = gsub('[a-z]*','', KEGG_Pathway)) %>% #Removing prefixes
  separate_rows(KEGG_Pathway, sep = ',') %>% #Dealing with multiple category assignments
  distinct(KEGG_Pathway, orf, type, tpm, treatment) %>%
  group_by(type, KEGG_Pathway) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_Pathway = forcats::as_factor(KEGG_Pathway) %>% fct_reorder(tpm, .desc = FALSE)) %>%
 group_by(type) %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  ungroup()

top10Tax <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_Pathway = gsub('[a-z]*','', KEGG_Pathway)) %>% #Removing prefixes
  separate_rows(KEGG_Pathway, sep = ',') %>% #Dealing with multiple category assignments
  distinct(KEGG_Pathway, orf, type, tpm) %>% #Removing duplicates due to prefixes
  inner_join(bbmap_p %>% distinct(orf, chr), by = "orf") %>% #Getting contig for taxonomy annotation
  inner_join(taxonomy %>% filter(superkingdom %in% c("Bacteria", "Archaea")), by = "chr") %>%
  mutate(class = na_if(class, "no support"),
         phylum = na_if(phylum, "no support")) %>%
  mutate(taxa_group = coalesce(class, phylum, superkingdom))  %>%
  group_by(taxa_group) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  pull(taxa_group)

bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_Pathway = gsub('[a-z]*','', KEGG_Pathway)) %>% #Removing prefixes
  separate_rows(KEGG_Pathway, sep = ',') %>% #Dealing with multiple category assignments
  distinct(treatment, KEGG_Pathway, orf, type, tpm) %>% #Removing duplicates due to prefixes
  inner_join(bbmap_p %>% distinct(orf, chr), by = "orf") %>% #Getting contig for taxonomy annotation
  inner_join(taxonomy %>% filter(superkingdom %in% c("Bacteria", "Archaea")), by = "chr") %>%
 mutate(class = na_if(class, "no support"),
         phylum = na_if(phylum, "no support")) %>% #Replacing the no support wth NA
  mutate(taxa_group = coalesce(class, phylum, superkingdom))  %>%
  mutate(taxa_group = ifelse(taxa_group %in% top10Tax, paste0(taxa_group), paste0("Other"))) %>%
  mutate(taxa_group = case_when(taxa_group == superkingdom ~ paste0("d_",taxa_group),
                                 taxa_group == phylum ~ paste0("p_",taxa_group),
                                 taxa_group == class ~ paste0("c_", taxa_group),
                                 TRUE ~ paste0(taxa_group)))  %>%
  group_by(type, KEGG_Pathway, taxa_group) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup()  
  group_by(type, KEGG_Pathway) %>%
  mutate(relab = tpm/sum(tpm)) %>%
  ungroup() %>%
  #filter(full_name %in% SelCats) %>%
  #mutate(KEGG_Pathway = factor(KEGG_Pathway, levels = levelVec)) %>%
  group_by(type, KEGG_Pathway) %>%
  mutate(relab = tpm/sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_Pathway %in% unique(topPathlevels$KEGG_Pathway)) %>%
  left_join(pathway_key, by = "KEGG_Pathway") %>%
 #filter(top %in% SelCats) %>%
  ggplot(mapping = aes(x = pathway, y = relab, fill = fct_relevel(taxa_group, "Other", after = Inf))) +
  geom_col() +
  theme_minimal() +
  xlab("KEGG Pathway") +
  ylab("Relative abundance") +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold")) +
  coord_flip() +
  facet_grid(~ type) +
  guides(fill=guide_legend(ncol=2, title.position = "top")) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS) +
  scale_y_continuous(labels=c(0,0.25,0.50,0.75,1))
```


### KEGG-categories higher levels
```{r}

topPath2levels <- bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
  mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                          orf %in% downReg ~ "C-DE",
                          TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
   filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_Pathway = gsub('[a-z]*','', KEGG_Pathway)) %>% #Removing prefixes
  separate_rows(KEGG_Pathway, sep = ',') %>% #Dealing with multiple category assignments
  distinct(KEGG_Pathway, orf, type, tpm, treatment) %>%
  inner_join(orf_KEGG2_key,  by = "orf") %>%
  group_by(type, KEGG_level_2) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  #filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_level_2 = forcats::as_factor(KEGG_level_2) %>% fct_reorder(tpm, .desc = FALSE)) %>%
 group_by(type) %>%
  arrange(desc(tpm)) %>%
  slice(1:10) %>%
  ungroup()

bbmap_p %>%
  inner_join(sample_ID %>% filter(day == "17"), by = "sample") %>% # Selecting relevant day
  filter(treatment %in% c("TN","C")) %>% # Selecting relevant treatments
  group_by(orf, treatment) %>%
  summarise(tpm = mean(tpm)) %>% # summarising mean tpm per treatment
  ungroup() %>%
 # mutate(type = case_when(orf %in% upReg ~ "TN-DE", #Mutating in up/downregulation information
                        #  orf %in% downReg ~ "C-DE",
                       #   TRUE ~ "non-DE")) %>%
  inner_join(eggnogs, by = "orf") %>%
  filter(KEGG_Pathway != "-") %>%
  mutate(KEGG_Pathway = gsub('[a-z]*','', KEGG_Pathway)) %>% #Removing prefixes
  separate_rows(KEGG_Pathway, sep = ',') %>% #Dealing with multiple category assignments
  distinct(treatment, KEGG_Pathway, orf, type, tpm) %>% #Removing duplicates due to prefixes
  inner_join(bbmap_p %>% distinct(orf, chr), by = "orf") %>% #Getting contig for taxonomy annotation
  inner_join(taxonomy %>% filter(superkingdom %in% c("Bacteria", "Archaea")), by = "chr") %>%
 mutate(class = na_if(class, "no support"),
         phylum = na_if(phylum, "no support")) %>% #Replacing the no support wth NA
  mutate(taxa_group = coalesce(class, phylum, superkingdom))  %>%
  mutate(taxa_group = ifelse(taxa_group %in% top10Tax, paste0(taxa_group), paste0("Other"))) %>%
  mutate(taxa_group = case_when(taxa_group == superkingdom ~ paste0("d_",taxa_group),
                                 taxa_group == phylum ~ paste0("p_",taxa_group),
                                 taxa_group == class ~ paste0("c_", taxa_group),
                                 TRUE ~ paste0(taxa_group)))  %>%
inner_join(orf_KEGG2_key,  by = "orf") %>%
  group_by(type, KEGG_level_2, taxa_group) %>%
  summarise(tpm = sum(tpm)) %>%
  ungroup() %>%
  group_by(type, KEGG_level_2) %>%
  mutate(relab = tpm/sum(tpm)) %>%
  ungroup() %>%
  #filter(full_name %in% SelCats) %>%
  #mutate(KEGG_Pathway = factor(KEGG_Pathway, levels = levelVec)) %>%
  group_by(type, KEGG_level_2) %>%
  mutate(relab = tpm/sum(tpm)) %>%
  ungroup() %>%
  filter(KEGG_level_2 != "Global_and_overview_maps") %>%
 # filter(KEGG_Pathway %in% unique(topPathlevels$KEGG_Pathway)) %>%
  #left_join(pathway_key, by = "KEGG_Pathway") %>%
 #filter(top %in% SelCats) %>%
  ggplot(mapping = aes(x = KEGG_level_2, y = relab, fill = fct_relevel(taxa_group, "Other", after = Inf))) +
  geom_col() +
  theme_minimal() +
  xlab("KEGG Pathway") +
  ylab("Relative abundance") +
  theme(legend.position = "bottom", axis.text = element_text(size = 7),
        legend.title = element_text(face = "bold")) +
  coord_flip() +
  facet_grid(~ type) +
  guides(fill=guide_legend(ncol=2, title.position = "top")) +
  scale_fill_manual('Taxonomic group', values = GEOM_COL_COLOURS) +
  scale_y_continuous(labels=c(0,0.25,0.50,0.75,1))
```

